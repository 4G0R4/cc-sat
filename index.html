<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â†¯ Stacker.News CC/SAT Exchange Order Book</title>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">

    <style>

		.google-sans {
		  font-family: "Google Sans", sans-serif;
		  font-optical-sizing: auto;
		  font-weight: <weight>;
		  font-style: normal;
		  font-variation-settings:
		    "GRAD" 0;
		}  	

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Google Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #121214;
            color: #e7e7e7;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.2em;
            color: #fada5e;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #8b949e;
            font-size: 0.95em;
        }
        
        .warning-banner {
		    background: #fada5e1a;
		    border: 1px solid #fada5e;
		    border-radius: 8px;
		    padding: 15px;
		    margin-bottom: 15px;
		    color: #fada5e;
            font-size: 0.9em;
        }
        
        .warning-banner strong {
            display: block;
            margin-bottom: 5px;
            color: #fada5e;
        }
        
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .kpi-card {
            background: #1c1f26;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .kpi-label {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #e7e7e7;
        }
        
        .kpi-value.positive {
            color: #3fb950;
        }
        
        .kpi-value.negative {
            color: #f85149;
        }
        
        .kpi-value.neutral {
            color: #fada5e;
        }
        
        .chart-container {
            background: #1c1f26;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 15px;
            height: 400px;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }
        
        button {
            background: #fada5e;
            color: black;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        button:hover {
        	color: white;
            background: #ff8533;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #30363d;
            color: #8b949e;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #30363d;
            color: #e7e7e7;
        }
        
        .btn-secondary:hover {
            background: #3d444d;
        }
        
        .order-book {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 35px;
        }
        
        .book-side {
            background: #1c1f26;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }
        
        .book-side h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .asks h3 {
            color: #f85149;
        }
        
        .bids h3 {
            color: #3fb950;
        }
        
        .order-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 60px;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
            align-items: center;
        }
        
        .asks .order-row {
            border-left: 3px solid #f85149;
        }
        
        .bids .order-row {
            border-left: 3px solid #3fb950;
        }
        
        .order-header {
            font-weight: 600;
            color: #8b949e;
            background: transparent !important;
            border: none !important;
        }
        
        .small-btn {
            padding: 6px 12px;
            font-size: 0.8em;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: #1c1f26;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #30363d;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            color: #fada5e;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .close {
            color: #8b949e;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1.2;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #e7e7e7;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #8b949e;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e7e7e7;
            font-family: inherit;
            font-size: 0.95em;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #fada5e;
            background: #161b22;
        }
        
        a {
        	color: inherit;
        }

        .status {
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .status.loading {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid #58a6ff;
            color: #58a6ff;
        }
        
        .status.error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            color: #f85149;
        }
        
        .status.success {
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid #3fb950;
            color: #3fb950;
        }
        
        .info-text {
            color: #8b949e;
            font-size: 0.85em;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .order-book {
                grid-template-columns: 1fr;
            }
            
            .kpi-section {
                grid-template-columns: 1fr 1fr;
            }
            
            .order-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            h1 {
                font-size: 1.6em;
            }
        }

        .info-icon {cursor: context-menu;}

        footer {
            margin: 1rem;
            padding: 1rem;
            color: #787878;
            text-align: center;
        }

        .header a,
        footer a {
            color: #bbbbbb;
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
			<h1>â†¯ Stacker.News CC/SAT Exchange Order Book</h1>
            <div class="subtitle">Order book for Cowboy Credits (CC) â‡„ Satoshis (SAT) trading on Stacker News - Place your order below or comment in the <a href="https://stacker.news/items/1349267/r/AGORA" target="_blank">annoucement post</a>.</div>
        </header>

        <div class="warning-banner">
            <strong>âš  Sybil Fees Notice</strong>
            Consider Stacker.News <a href="https://stacker.news/items/730254/r/AGORA" target="_blank">30% sybil fees</a> on transactions when placing orders. The effective rate is 1CC=1sats when buying CCs from Stacker.news/credits. 
            Territory founders currently receive 21% back when transacting on their territories, allowing them to offer better rates. Mouse over the &#9432 to read more details about each offer.
            Data submitted and maintained by the SN community: click the Ã— to permanently delete any obsolete offer.
        </div>

        <div class="kpi-section">
            <div class="kpi-card">
                <div class="kpi-label">Best Bid</div>
                <div class="kpi-value positive" id="kpiBestBid">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Actual Price</div>
                <div class="kpi-value neutral" id="kpiActualPrice">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Best Ask</div>
                <div class="kpi-value negative" id="kpiBestAsk">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Spread</div>
                <div class="kpi-value" id="kpiSpread">-</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="depthChart"></canvas>
        </div>

        <div class="order-book">

            <div class="book-side bids">
                <h3>ðŸ“— BIDS (Buy Orders)</h3>
                <div class="order-row order-header">
                    <div>Price</div>
                    <div>Volume</div>
                    <div>Contact</div>
                    <div></div>
                </div>
                <div id="bidsList"></div>
            </div>

            <div class="book-side asks">
                <h3>ðŸ“• ASKS (Sell Orders)</h3>
                <div class="order-row order-header">
                    <div>Price</div>
                    <div>Volume</div>
                    <div>Contact</div>
                    <div></div>
                </div>
                <div id="asksList"></div>
            </div>
            
        </div>

        <div class="action-buttons">
            <button onclick="window.open('https://stacker.news/items/1349267/r/AGORA', '_blank')" class="btn-secondary">[-] Read SN Announcement</button>
            <button onclick="loadOrders()">[â†»] Refresh Orders</button>
            <button onclick="openModal('orderModal')">[â†¯] Submit Order via SN</button>
            <button onclick="openModal('orderModal')">[&#726;] Submit Order via GH</button>
            <button onclick="openModal('settingsModal')" class="btn-secondary">[&#9965;] GH Settings</button>
        </div>


    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>[&#9965;] Settings</h2>
                <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div id="settingsStatus" class="status" style="display:none;"></div>
            <div class="form-group">
                <label>GitHub Personal Access Token (required to submit/edit orders):</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxx">
                <div class="info-text">Generate yours at <a href="https://github.com/settings/tokens" target="_blank"><strong><code>github.com/settings/tokens</code></strong></a> with <strong>&#32;<code>&#32;gist</code></strong> scope</div>
            </div>
            <div class="form-group">
                <label>Gist ID:</label>
                <input type="text" id="gistId" value="a52699d9f7209a225ae6d10d77d53eca" readonly>
                <div class="info-text">Default <strong><code>gist</code></strong> order book is <strong><code>a52699d9f7209a225ae6d10d77d53eca</code></strong>- do not change unless creating private book</div>
            </div>
            <button onclick="saveConfig()">[&#187;] Save Configuration</button>
        </div>
    </div>

    <!-- Order Submission Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>[&#726;] Submit New Order</h2>
                <span class="close" onclick="closeModal('orderModal')">&times;</span>
            </div>
            <div id="orderStatus" class="status" style="display:none;"></div>
            <div class="form-group">
                <label>Order Type:</label>
                <select id="orderType">
                    <option value="bid">BUY CCs (Bid - I want to buy CCs with sats)</option>
                    <option value="ask">SELL CCs (Ask - I want to sell CCs for sats)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Price (CC/SAT rate, e.g., 0.9 means 0.9 sats per CC):</label>
                <input type="number" id="orderPrice" step="0.01" min="0.01" placeholder="0.85">
            </div>
            <div class="form-group">
                <label>Volume (CCs):</label>
                <input type="number" id="orderVolume" step="100" min="1" placeholder="10000">
            </div>
            <div class="form-group">
                <label>Contact Info (optional - SN username, nostr, etc.):</label>
                <input type="text" id="orderContact" placeholder="@username or npub...">
            </div>
            <div class="form-group">
                <label>Notes (optional - fees included, territory founder status, etc.):</label>
                <textarea id="orderNotes" rows="2" placeholder="e.g., 'Territory founder - sybil fees included'"></textarea>
            </div>
            <button onclick="submitOrder()">[&#187;] Submit Order</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let orders = { asks: [], bids: [] };
        let config = { token: '', gistId: 'a52699d9f7209a225ae6d10d77d53eca' };
        let depthChart = null;

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        function loadConfig() {
            const saved = localStorage.getItem('ccOrderBookConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('githubToken').value = config.token || '';
                document.getElementById('gistId').value = config.gistId || 'a52699d9f7209a225ae6d10d77d53eca';
            }
        }

        function saveConfig() {
            config.token = document.getElementById('githubToken').value.trim();
            config.gistId = document.getElementById('gistId').value.trim() || 'a52699d9f7209a225ae6d10d77d53eca';
            
            localStorage.setItem('ccOrderBookConfig', JSON.stringify(config));
            showStatus('Configuration saved!', 'success', 'settingsStatus');
            
            setTimeout(() => closeModal('settingsModal'), 1500);
        }

        function showStatus(message, type, elementId = 'orderStatus') {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`);
                
                if (!response.ok) throw new Error('Failed to load orders');
                
                const data = await response.json();
                const content = data.files['orders.json'].content;
                orders = JSON.parse(content);
                
                renderOrderBook();
                updateKPIs();
                renderDepthChart();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        async function saveOrders() {
            if (!config.token) {
                showStatus('Please configure GitHub token in Settings first', 'error');
                return false;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'orders.json': {
                                content: JSON.stringify(orders, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('Failed to save orders');
                
                return true;
            } catch (error) {
                showStatus(`Error saving: ${error.message}`, 'error');
                return false;
            }
        }

        async function submitOrder() {
            if (!config.token) {
                showStatus('Please configure GitHub token in Settings first', 'error');
                return;
            }

            const type = document.getElementById('orderType').value;
            const price = parseFloat(document.getElementById('orderPrice').value);
            const volume = parseFloat(document.getElementById('orderVolume').value);
            const contact = document.getElementById('orderContact').value.trim();
            const notes = document.getElementById('orderNotes').value.trim();

            if (!price || price <= 0) {
                showStatus('Please enter a valid price', 'error');
                return;
            }

            if (!volume || volume <= 0) {
                showStatus('Please enter a valid volume', 'error');
                return;
            }

            const order = {
                id: Date.now().toString(),
                price: price,
                volume: volume,
                contact: contact || 'Anonymous',
                notes: notes,
                timestamp: new Date().toISOString()
            };

            if (type === 'ask') {
                orders.asks.push(order);
                orders.asks.sort((a, b) => a.price - b.price);
            } else {
                orders.bids.push(order);
                orders.bids.sort((a, b) => b.price - a.price);
            }

            showStatus('Submitting order...', 'loading');
            
            if (await saveOrders()) {
                showStatus('Order submitted successfully!', 'success');
                renderOrderBook();
                updateKPIs();
                renderDepthChart();
                
                document.getElementById('orderPrice').value = '';
                document.getElementById('orderVolume').value = '';
                document.getElementById('orderContact').value = '';
                document.getElementById('orderNotes').value = '';
                
                setTimeout(() => closeModal('orderModal'), 2000);
            }
        }

        async function removeOrder(type, orderId) {
            if (!config.token) {
                alert('Please configure GitHub token in Settings to edit orders');
                return;
            }

            if (!confirm('Mark this order as completed and remove it?')) return;

            if (type === 'ask') {
                orders.asks = orders.asks.filter(o => o.id !== orderId);
            } else {
                orders.bids = orders.bids.filter(o => o.id !== orderId);
            }
            
            if (await saveOrders()) {
                renderOrderBook();
                updateKPIs();
                renderDepthChart();
            }
        }

        function updateKPIs() {
            const bestBid = orders.bids.length > 0 ? orders.bids[0].price : null;
            const bestAsk = orders.asks.length > 0 ? orders.asks[0].price : null;
            
            document.getElementById('kpiBestBid').textContent = bestBid ? bestBid.toFixed(4) : '-';
            document.getElementById('kpiBestAsk').textContent = bestAsk ? bestAsk.toFixed(4) : '-';
            
            if (bestBid && bestAsk) {
                const mid = (bestBid + bestAsk) / 2;
                const spread = bestBid - bestAsk;
                
                document.getElementById('kpiActualPrice').textContent = mid.toFixed(4);
                document.getElementById('kpiSpread').textContent = spread.toFixed(4);
            } else {
                document.getElementById('kpiActualPrice').textContent = '-';
                document.getElementById('kpiSpread').textContent = '-';
            }
        }

        function renderDepthChart() {
            const ctx = document.getElementById('depthChart').getContext('2d');
            
            if (depthChart) {
                depthChart.destroy();
            }

            // Calculate cumulative volumes
            let bidDepth = [];
            let askDepth = [];
            let cumBidVol = 0;
            let cumAskVol = 0;

            // Bids (reverse order for chart)
            for (let i = orders.bids.length - 1; i >= 0; i--) {
                cumBidVol += orders.bids[i].volume;
                bidDepth.push({ x: orders.bids[i].price, y: cumBidVol });
            }

            // Asks
            for (let i = 0; i < orders.asks.length; i++) {
                cumAskVol += orders.asks[i].volume;
                askDepth.push({ x: orders.asks[i].price, y: cumAskVol });
            }

            depthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Bids',
                        data: bidDepth,
                        borderColor: '#3fb950',
                        backgroundColor: 'rgba(63, 185, 80, 0.1)',
                        fill: true,
                        stepped: true,
                        tension: 0
                    }, {
                        label: 'Asks',
                        data: askDepth,
                        borderColor: '#f85149',
                        backgroundColor: 'rgba(248, 81, 73, 0.1)',
                        fill: true,
                        stepped: true,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e7e7e7',
                                font: { size: 12 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Market Depth',
                            color: '#fada5e',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Price (CC/SAT)',
                                color: '#8b949e'
                            },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative Volume (CC)',
                                color: '#8b949e'
                            },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        }

        function renderOrderBook() {
            const asksHtml = orders.asks.map(order => `
                <div class="order-row">
                    <div>${order.price.toFixed(4)}</div>
                    <div>${order.volume.toLocaleString()} CC</div>
                    <div>
                        ${formatContact(order.contact)}
                        ${order.notes ? `<span class="info-icon" title="${escapeHtml(order.notes)}" alt="${escapeHtml(order.notes)}">&#9432</span>` : ''}
                    </div>
                    <div>
                        <button class="small-btn" onclick="removeOrder('ask', '${order.id}')">Ã—</button>
                    </div>
                </div>
            `).join('');

            const bidsHtml = orders.bids.map(order => `
                <div class="order-row">
                    <div>${order.price.toFixed(4)}</div>
                    <div>${order.volume.toLocaleString()} CC</div>
                    <div>
                        ${formatContact(order.contact)}
                        ${order.notes ? `<span class="info-icon" title="${escapeHtml(order.notes)}" alt="${escapeHtml(order.notes)}">&#9432</span>` : ''}
                    </div>
                    <div>
                        <button class="small-btn" onclick="removeOrder('bid', '${order.id}')">Ã—</button>
                    </div>
                </div>
            `).join('');

            document.getElementById('asksList').innerHTML = asksHtml || '<div style="padding:20px; text-align:center; color:#8b949e;">No sell orders</div>';
            document.getElementById('bidsList').innerHTML = bidsHtml || '<div style="padding:20px; text-align:center; color:#8b949e;">No buy orders</div>';
        }

        function formatContact(contact) {
            if (!contact || contact === 'Anonymous') {
                return contact || 'Anonymous';
            }
            
            // Check if it's a single word (no spaces)
            const words = contact.trim().split(/\s+/);
            if (words.length > 1) {
                return escapeHtml(contact);
            }
            
            const cleanContact = contact.trim();
            
            // Check for npub
            if (cleanContact.startsWith('npub')) {
                return `<a href="https://njump.me/${cleanContact}" target="_blank" class="contact-link">${cleanContact}</a>`;
            }
            
            // Check for Stacker.News username (starts with @ or is just a word)
            if (cleanContact.startsWith('@')) {
                const username = cleanContact.substring(1);
                return `<a href="https://stacker.news/${username}" target="_blank" class="contact-link">${cleanContact}</a>`;
            }
            
            // Assume it's a stacker.news username without @
            return `<a href="https://stacker.news/${cleanContact}" target="_blank" class="contact-link">@${cleanContact}</a>`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadConfig();
        loadOrders();
    </script>

        <footer>
            <p><small>ðŸ„¯ â†¯ Stacker.News CC/SAT Exchange Order Book
                - <a href="https://github.com/4G0R4/cc-sat" target="_blank">Repository</a> 
                - <a href="https://github.com/4G0R4/cc-sat/issues/new" target="_blank">Open a issue</a> 
                - <a href="https://stacker.news/items/1349267/r/AGORA" target="_blank">Place your order on SN</a> -
            </small></p>
        </footer>


</body>
</html>
